<!DOCTYPE html><html><head><link rel="icon" href="/favicon.svg"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-T7N1H2YY9Q"></script><script>
                                window.dataLayer = window.dataLayer || [];
                                function gtag(){dataLayer.push(arguments);}
                                gtag('js', new Date());
                                gtag('config', 'G-T7N1H2YY9Q', {
                                page_path: window.location.pathname,
                                });
                            </script><meta charSet="utf-8"/><title>Brod | Guides | Macros</title><meta name="description" content="Macros"/><meta property="og:url" content="https://brod.sh"/><meta property="og:site_name" content="https://brod.sh"/><meta property="og:image" content="https://brod.sh/_next/static/images/icon-brand-gradient-fill-bf8162a07751a42ce3538c2e2433fc70.png"/><meta property="og:title" content="Declarative web-scraping and data integration for NodeJS"/><meta property="og:description" content="Brod provides a declarative NodeJS API for scraping and integrating with unstructured data sources such as APIs and websites"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta property="twitter:title" content="Brod | Guides | Macros"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="11"/><link rel="preload" href="/_next/static/css/5c40c3a07cd778d2f82d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5c40c3a07cd778d2f82d.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-fc1622c72e13263d56f7.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework-a4e612bcceec6b8ac8b2.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-c8b51cc0a92c3008cd1b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-c16188b8fba4a2007883.js" as="script"/><link rel="preload" href="/_next/static/chunks/841-f8dd28b3d185e0db52d0.js" as="script"/><link rel="preload" href="/_next/static/chunks/597-b842ce2421a7f6b4d8ce.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/guides/%5B...slug%5D-1f61d9f29033afc19e5d.js" as="script"/></head><body><div id="__next"><main class="flex flex-col min-h-screen items-start"><div class="w-full mx-auto flex-shrink-0"><div class="z-30 relative mx-auto max-w-7xl"><div class="flex justify-between items-center px-4 py-6 sm:px-6 md:justify-start md:space-x-24"><span class="select-none text-base font-medium cursor-pointer mt-0.5  text-primary-500"><svg width="64" height="32" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-0.5  text-primary-500"><path d="M9.194 16.8c1.33 0 2.534.308 3.612.924 1.097.615 1.96 1.501 2.588 2.66.647 1.14.971 2.47.971 3.99s-.324 2.858-.97 4.016c-.63 1.158-1.492 2.054-2.589 2.687-1.078.615-2.282.923-3.612.923-1.924 0-3.362-.57-4.314-1.71v1.466H0v-20.14h5.122v6.705c.989-1.014 2.346-1.52 4.072-1.52zM8.114 27.903c.899 0 1.636-.308 2.21-.923.576-.633.864-1.502.864-2.606 0-1.085-.288-1.936-.863-2.551-.575-.615-1.312-.923-2.21-.923-.9 0-1.637.308-2.212.923-.575.615-.862 1.466-.862 2.551 0 1.104.287 1.973.862 2.606.575.615 1.312.923 2.211.923zM23.626 18.81a4.683 4.683 0 012.022-1.494c.845-.343 1.806-.515 2.884-.515v4.64a10.398 10.398 0 00-1.159-.08c-1.096 0-1.959.298-2.588.895-.611.597-.917 1.511-.917 2.741v6.759h-5.122V17.045h4.88v1.764zM37.848 32c-1.564 0-2.975-.326-4.233-.977-1.258-.651-2.247-1.556-2.965-2.714-.701-1.158-1.052-2.47-1.052-3.936 0-1.447.35-2.75 1.052-3.908a7.29 7.29 0 012.938-2.687c1.258-.652 2.678-.977 4.26-.977 1.582 0 3.002.325 4.26.977 1.258.633 2.237 1.529 2.938 2.687.701 1.14 1.052 2.442 1.052 3.908 0 1.466-.35 2.778-1.052 3.936-.7 1.158-1.68 2.063-2.938 2.714-1.258.651-2.678.977-4.26.977zm0-4.098c.899 0 1.636-.308 2.21-.923.576-.633.864-1.502.864-2.606 0-1.085-.288-1.936-.863-2.551-.575-.615-1.312-.923-2.211-.923-.899 0-1.636.308-2.21.923-.576.615-.863 1.466-.863 2.551 0 1.104.287 1.973.862 2.606.575.615 1.312.923 2.211.923zM64 11.617v20.139h-4.88V30.29C58.168 31.43 56.74 32 54.834 32c-1.33 0-2.544-.308-3.64-.923-1.097-.633-1.968-1.529-2.615-2.687-.63-1.158-.944-2.497-.944-4.017 0-1.52.315-2.85.944-3.99.647-1.158 1.518-2.044 2.615-2.66 1.096-.615 2.31-.922 3.64-.922 1.743 0 3.09.506 4.043 1.52v-6.704H64zm-8.088 16.285c.88 0 1.608-.308 2.184-.923.575-.633.862-1.502.862-2.606 0-1.085-.287-1.936-.862-2.551-.557-.615-1.285-.923-2.184-.923-.899 0-1.636.308-2.21.923-.576.615-.864 1.466-.864 2.551 0 1.104.288 1.973.863 2.606.575.615 1.312.923 2.21.923z" fill="currentColor"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M30.536.068c-2.396-.36-4.616 1.336-4.917 3.756a4.342 4.342 0 003.266 4.76c.13.03.224.147.22.281l-.125 3.848a1.353 1.353 0 001.348 1.4h14.487c.766 0 1.378-.64 1.347-1.41l-.158-3.975a.283.283 0 01.19-.275 4.357 4.357 0 002.826-4.716c-.338-2.386-2.54-4.04-4.908-3.69l-5.604.83a8.838 8.838 0 01-2.607-.003L30.536.068zm3.003 5.089a.947.947 0 00-.944.95v3.528c0 .525.423.95.944.95a.947.947 0 00.943-.95V6.107a.947.947 0 00-.943-.95zm3.774 5.428a.947.947 0 01-.943-.95V6.107c0-.525.422-.95.943-.95.521 0 .944.425.944.95v3.528c0 .525-.423.95-.944.95zm3.775-5.428a.947.947 0 00-.944.95v3.528c0 .525.422.95.944.95a.947.947 0 00.943-.95V6.107a.947.947 0 00-.943-.95z" fill="currentColor"></path></svg></span><div class="-mr-2 -my-2 md:hidden"><button class="rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 text-gray-300" id="headlessui-popover-button-undefined" type="button"><span class="sr-only">Open menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div><div class="hidden md:flex-1 md:flex md:items-center md:justify-between"><nav class="flex space-x-10"><span class="select-none text-base font-medium text-gray-700 hover:text-gray-800"><a href="/docs">API</a></span><span class="select-none text-primary-600 hover:text-primary-600 text-base font-medium text-gray-700 hover:text-gray-800"><a href="/guides/getting-started/introduction">Guides</a></span><span class="select-none text-base font-medium text-gray-700 hover:text-gray-800"><a href="/examples">Examples</a></span><span class="select-none text-base font-medium text-gray-700 hover:text-gray-800"><a href="/blog">Blog</a></span></nav><div class="flex items-center md:ml-12"><a href="https://github.com/brodhq/brod" rel="noopener" target="_blank" class="text-gray-700 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" class="h-8 w-8"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div></div></div></div></div><div class="px-4 max-w-5xl sm:px-6 md:px-8 py-4 md:py-16 flex-1 mx-auto w-full grid grid-cols-1 gap-8 md:grid-cols-3 md:gap-24"><div class="col-span-2 order-2 md:order-1 pb-12 md:pb-16"><h2 class="text-gray-400">Metaprogramming</h2><h1 class="prose text-4xl">Macros</h1><ul class="space-y-2 mt-10"><li class="flex"><div class="w-5 text-gray-500">1<!-- -->.</div><a class="text-primary-800 underline" href="#foreword">Foreword</a></li><li class="flex"><div class="w-5 text-gray-500">2<!-- -->.</div><a class="text-primary-800 underline" href="#our-first-macro">Our first macro</a></li><li class="flex"><div class="w-5 text-gray-500">3<!-- -->.</div><a class="text-primary-800 underline" href="#macro-hygiene">Macro hygiene</a></li><li class="flex"><div class="w-5 text-gray-500">4<!-- -->.</div><a class="text-primary-800 underline" href="#the-environment">The environment</a></li><li class="flex"><div class="w-5 text-gray-500">5<!-- -->.</div><a class="text-primary-800 underline" href="#private-macros">Private macros</a></li><li class="flex"><div class="w-5 text-gray-500">6<!-- -->.</div><a class="text-primary-800 underline" href="#write-macros-responsibly">Write macros responsibly</a></li></ul><div class="my-4 md:my-8 space-y-5"><h2 id=foreword class="prose prose-2xl">Foreword</h2><p class="prose">Even though Geis attempts its best to provide a safe environment for macros, the major responsibility of writing clean code with macros falls on developers. Macros are harder to write than ordinary Geis functions and it&#39;s considered to be bad style to use them when they&#39;re not necessary. So write macros responsibly.</p><p class="prose">Geis already provides mechanisms to write your everyday code in a simple and readable fashion by using its data structures and functions. Macros should only be used as a last resort. Remember that <strong>explicit is better than implicit</strong>. <strong>Clear code is better than concise code.</strong></p><h2 id=our-first-macro class="prose prose-2xl">Our first macro</h2><p class="prose">Macros in Geis are defined via <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">defmacro/2</span>.</p><blockquote>
<p class="prose">For this chapter, we will be using files instead of running code samples in IEx. That&#39;s because the code samples will span multiple lines of code and typing them all in IEx can be counter-productive. You should be able to run the code samples by saving them into a <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">macros.exs</span> file and running it with <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">geis macros.exs</span> or <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">iex macros.exs</span>.</p></blockquote>
<p class="prose">In order to better understand how macros work, let&#39;s create a new module where we are going to implement <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">unless</span>, which does the opposite of <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">if</span>, as a macro and as a function:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule Unless </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  def fun_unless(clause, </span><span style="color:#d19a66">do</span><span>: expression) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    </span><span style="color:#c678dd">if</span><span>(!clause, </span><span style="color:#d19a66">do</span><span>: expression)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span><span>  defmacro macro_unless(clause, </span><span style="color:#d19a66">do</span><span>: expression) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>    quote </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span><span>      </span><span style="color:#c678dd">if</span><span>(!unquote(clause), </span><span style="color:#d19a66">do</span><span>: unquote(expression))
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span>    end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span>end
</code></pre></div><p class="prose">The function receives the arguments and passes them to <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">if</span>. However, as we learned in the <a href="/getting-started/meta/quote-and-unquote.html">previous chapter</a>, the macro will receive quoted expressions, inject them into the quote, and finally return another quoted expression.</p><p class="prose">Let&#39;s start <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">iex</span> with the module above:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>$ iex macros.exs</span></code></pre></div><p class="prose">And play with those definitions:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>iex&gt; </span><span style="color:#e6c07b">require</span><span> Unless
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>iex&gt; Unless.macro_unless </span><span style="color:#56b6c2">true</span><span>, </span><span style="color:#d19a66">do</span><span>: IO.puts </span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span>nil
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span><span>iex&gt; Unless.fun_unless </span><span style="color:#56b6c2">true</span><span>, </span><span style="color:#d19a66">do</span><span>: IO.puts </span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span><span></span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>nil
</code></pre></div><p class="prose">Note that in our macro implementation, the sentence was not printed, although it was printed in our function implementation. That&#39;s because the arguments to a function call are evaluated before calling the function. However, macros do not evaluate their arguments. Instead, they receive the arguments as quoted expressions which are then transformed into other quoted expressions. In this case, we have rewritten our <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">unless</span> macro to become an <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">if</span> behind the scenes.</p><p class="prose">In other words, when invoked as:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>Unless.macro_unless </span><span style="color:#56b6c2">true</span><span>, </span><span style="color:#d19a66">do</span><span>: IO.puts </span><span style="color:#98c379">&quot;this should never be printed&quot;</span></code></pre></div><p class="prose">Our <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">macro_unless</span> macro received the following:</p><p class="prose">{% raw %}</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>macro_unless(</span><span style="color:#56b6c2">true</span><span>, [</span><span style="color:#c678dd">do</span><span>: {{:., [], [{:__aliases__, [alias: </span><span style="color:#56b6c2">false</span><span>], [:IO]}, :puts]}, [], [</span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>]}])</span></code></pre></div><p class="prose">{% endraw %}</p><p class="prose">And it then returned a quoted expression as follows:</p><p class="prose">{% raw %}</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>{:</span><span style="color:#c678dd">if</span><span>, [],
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span> [{:!, [], [</span><span style="color:#56b6c2">true</span><span>]},
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>  [</span><span style="color:#c678dd">do</span><span>: {{:., [],
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>     [{:__aliases__,
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>       [], [:IO]},
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span><span>      :puts]}, [], [</span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>]}]]}</span></code></pre></div><p class="prose">{% endraw %}</p><p class="prose">We can actually verify that this is the case by using <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.expand_once/2</span>:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>iex&gt; expr = quote </span><span style="color:#c678dd">do</span><span>: Unless.macro_unless(</span><span style="color:#56b6c2">true</span><span>, </span><span style="color:#d19a66">do</span><span>: IO.puts </span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span>iex&gt; res  = Macro.expand_once(expr, __ENV__)
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span>iex&gt; IO.puts Macro.to_string(res)
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span><span></span><span style="color:#c678dd">if</span><span>(!</span><span style="color:#56b6c2">true</span><span>) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span><span>  IO.puts(</span><span style="color:#98c379">&quot;this should never be printed&quot;</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span><span></span><span style="color:#d19a66">end</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span>:ok
</code></pre></div><p class="prose"><span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.expand_once/2</span> receives a quoted expression and expands it according to the current environment. In this case, it expanded/invoked the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Unless.macro_unless/2</span> macro and returned its result. We then proceeded to convert the returned quoted expression to a string and print it (we will talk about <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">__ENV__</span> later in this chapter).</p><p class="prose">That&#39;s what macros are all about. They are about receiving quoted expressions and transforming them into something else. In fact, <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">unless/2</span> in Geis is implemented as a macro:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmacro unless(clause, </span><span style="color:#d19a66">do</span><span>: expression) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  quote </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    </span><span style="color:#c678dd">if</span><span>(!unquote(clause), </span><span style="color:#d19a66">do</span><span>: unquote(expression))
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>end
</code></pre></div><p class="prose">Constructs such as <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">unless/2</span>, <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">defmacro/2</span>, <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">def/2</span>, <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">defprotocol/2</span>, and many others used throughout this getting started guide are implemented in pure Geis, often as a macro. This means that the constructs being used to build the language can be used by developers to extend the language to the domains they are working on.</p><p class="prose">We can define any function and macro we want, including ones that override the built-in definitions provided by Geis. The only exceptions are Geis special forms which are not implemented in Geis and therefore cannot be overridden, <a href="https://hexdocs.pm/geis/Kernel.SpecialForms.html#summary">the full list of special forms is available in <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Kernel.SpecialForms</span></a>.</p><h2 id=macro-hygiene class="prose prose-2xl">Macro hygiene</h2><p class="prose">Geis macros have late resolution. This guarantees that a variable defined inside a quote won&#39;t conflict with a variable defined in the context where that macro is expanded. For example:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule Hygiene </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  defmacro no_interference </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    quote </span><span style="color:#c678dd">do</span><span>: a = </span><span style="color:#d19a66">1</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>defmodule HygieneTest </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span><span>  def go </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span><span>    </span><span style="color:#e6c07b">require</span><span> Hygiene
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span><span>    a = </span><span style="color:#d19a66">13</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span>    Hygiene.no_interference()
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">12</span>    a
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">13</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">14</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">15</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">16</span>HygieneTest.go
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">17</span><span># =&gt; </span><span style="color:#d19a66">13</span></code></pre></div><p class="prose">In the example above, even though the macro injects <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">a = 1</span>, it does not affect the variable <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">a</span> defined by the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">go</span> function. If a macro wants to explicitly affect the context, it can use <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">var!</span>:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule Hygiene </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  defmacro interference </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    quote </span><span style="color:#c678dd">do</span><span>: </span><span style="color:#c678dd">var</span><span>!(a) = </span><span style="color:#d19a66">1</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>defmodule HygieneTest </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span><span>  def go </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span><span>    </span><span style="color:#e6c07b">require</span><span> Hygiene
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span><span>    a = </span><span style="color:#d19a66">13</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span>    Hygiene.interference()
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">12</span>    a
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">13</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">14</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">15</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">16</span>HygieneTest.go
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">17</span><span># =&gt; </span><span style="color:#d19a66">1</span></code></pre></div><p class="prose">The code above will work but issue a warning: <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">variable &amp;quot;a&amp;quot; is unused</span>. The macro is overriding the original value and the original value is never used.</p><p class="prose">Variable hygiene only works because Geis annotates variables with their context. For example, a variable <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">x</span> defined on line 3 of a module would be represented as:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>{:x, [line: </span><span style="color:#d19a66">3</span><span>], nil}</span></code></pre></div><p class="prose">However, a quoted variable is represented as:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule Sample </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  def quoted </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    quote </span><span style="color:#c678dd">do</span><span>: x
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>Sample.quoted() #=&gt; {:x, [line: </span><span style="color:#d19a66">3</span><span>], Sample}</span></code></pre></div><p class="prose">Notice that the third element in the quoted variable is the atom <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Sample</span>, instead of <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">nil</span>, which marks the variable as coming from the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Sample</span> module. Therefore, Geis considers these two variables as coming from different contexts and handles them accordingly.</p><p class="prose">Geis provides similar mechanisms for imports and aliases too. This guarantees that a macro will behave as specified by its source module rather than conflicting with the target module where the macro is expanded. Hygiene can be bypassed under specific situations by using macros like <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">var!/2</span> and <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">alias!/1</span>, although one must be careful when using those as they directly change the user environment.</p><p class="prose">Sometimes variable names might be dynamically created. In such cases, <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.var/2</span> can be used to define new variables:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule Sample </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  defmacro initialize_to_char_count(variables) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span>    Enum.map variables, fn(name) -&gt;
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span><span>      </span><span style="color:#c678dd">var</span><span> = Macro.var(name, nil)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span><span>      length = name |&gt; Atom.to_string |&gt; </span><span style="color:#e6c07b">String</span><span>.length
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span><span>      quote </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>        unquote(</span><span style="color:#c678dd">var</span><span>) = unquote(length)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span>      end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span>    end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">12</span><span>  def run </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">13</span>    initialize_to_char_count [:red, :green, :yellow]
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">14</span>    [red, green, yellow]
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">15</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">16</span>end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">17</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">18</span><span>&gt; Sample.run #=&gt; [</span><span style="color:#d19a66">3</span><span>, </span><span style="color:#d19a66">5</span><span>, </span><span style="color:#d19a66">6</span><span>]</span></code></pre></div><p class="prose">Take note of the second argument to <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.var/2</span>. This is the context being used and will determine hygiene as described in the next section.</p><h2 id=the-environment class="prose prose-2xl">The environment</h2><p class="prose">When calling <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.expand_once/2</span> earlier in this chapter, we used the special form <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">__ENV__</span>.</p><p class="prose"><span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">__ENV__</span> returns an instance of the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.Env</span> struct which contains useful information about the compilation environment, including the current module, file, and line, all variables defined in the current scope, as well as imports, requires and so on:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>iex&gt; __ENV__.module
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span>nil
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span>iex&gt; __ENV__.file
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span><span></span><span style="color:#98c379">&quot;iex&quot;</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>iex&gt; __ENV__.requires
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>[IEx.Helpers, Kernel, Kernel.Typespec]
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span>iex&gt; </span><span style="color:#e6c07b">require</span><span> Integer
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span>nil
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span>iex&gt; __ENV__.requires
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span>[IEx.Helpers, Integer, Kernel, Kernel.Typespec]
</code></pre></div><p class="prose">Many of the functions in the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro</span> module expect an environment. You can read more about these functions in <a href="https://hexdocs.pm/geis/Macro.html">the docs for the <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro</span> module</a> and learn more about the compilation environment in the <a href="https://hexdocs.pm/geis/Macro.Env.html">docs for <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">Macro.Env</span></a>.</p><h2 id=private-macros class="prose prose-2xl">Private macros</h2><p class="prose">Geis also supports private macros via <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">defmacrop</span>. As private functions, these macros are only available inside the module that defines them, and only at compilation time.</p><p class="prose">It is important that a macro is defined before its usage. Failing to define a macro before its invocation will raise an error at runtime, since the macro won&#39;t be expanded and will be translated to a function call:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>iex&gt; defmodule Sample </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>...&gt;  def four, </span><span style="color:#d19a66">do</span><span>: two + two
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>...&gt;  defmacrop two, </span><span style="color:#d19a66">do</span><span>: </span><span style="color:#d19a66">2</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>...&gt; end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span><span>** (CompileError) iex:</span><span style="color:#d19a66">2</span><span>: </span><span class="hljs-function" style="color:#c678dd">function</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#61aeee">two</span><span class="hljs-function">/0 </span><span class="hljs-function" style="color:#61aeee">undefined</span></code></pre></div><h2 id=write-macros-responsibly class="prose prose-2xl">Write macros responsibly</h2><p class="prose">Macros are a powerful construct and Geis provides many mechanisms to ensure they are used responsibly.</p><ul class="prose"><li class="p-1 ml-10"><p class="prose">  Macros are hygienic: by default, variables defined inside a macro are not going to affect the user code. Furthermore, function calls and aliases available in the macro context are not going to leak into the user context.</p></li><li class="p-1 ml-10"><p class="prose">  Macros are lexical: it is impossible to inject code or macros globally. In order to use a macro, you need to explicitly <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">require</span> or <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">import</span> the module that defines the macro.</p></li><li class="p-1 ml-10"><p class="prose">  Macros are explicit: it is impossible to run a macro without explicitly invoking it. For example, some languages allow developers to completely rewrite functions behind the scenes, often via parse transforms or via some reflection mechanisms. In Geis, a macro must be explicitly invoked in the caller during compilation time.</p></li><li class="p-1 ml-10"><p class="prose">  Macros&#39; language is clear: many languages provide syntax shortcuts for <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">quote</span> and <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">unquote</span>. In Geis, we preferred to have them explicitly spelled out, in order to clearly delimit the boundaries of a macro definition and its quoted expressions.</p></li></ul><p class="prose">Even with such guarantees, the developer plays a big role when writing macros responsibly. If you are confident you need to resort to macros, remember that macros are not your API. Keep your macro definitions short, including their quoted contents. For example, instead of writing a macro like this:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule MyModule </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  defmacro my_macro(a, b, c) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    quote </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span>      do_this(unquote(a))
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span>      ...
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span>      do_that(unquote(b))
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span>      ...
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span>      and_that(unquote(c))
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span>    end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span>  end
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span>end
</code></pre></div><p class="prose">write:</p><div class="block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400"><pre style="display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent"><code class="language-typescript" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">1</span><span>defmodule MyModule </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">2</span><span>  defmacro my_macro(a, b, c) </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">3</span><span>    quote </span><span style="color:#c678dd">do</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">4</span><span>      # Keep what you need to </span><span style="color:#c678dd">do</span><span> here to a minimum
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">5</span><span>      # and move everything </span><span style="color:#c678dd">else</span><span> to a </span><span class="hljs-function" style="color:#c678dd">function</span><span class="hljs-function">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">6</span><span class="hljs-function">      </span><span class="hljs-function" style="color:#61aeee">MyModule</span><span class="hljs-function">.</span><span class="hljs-function" style="color:#61aeee">do_this_that_and_that</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">unquote(a), unquote(b), unquote(c)</span><span class="hljs-function">)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">7</span><span class="hljs-function">    </span><span class="hljs-function" style="color:#61aeee">end</span><span class="hljs-function">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">8</span><span class="hljs-function">  </span><span class="hljs-function" style="color:#61aeee">end</span><span class="hljs-function">
</span><span class="hljs-function"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">9</span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">10</span><span class="hljs-function">  </span><span class="hljs-function" style="color:#61aeee">def</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#61aeee">do_this_that_and_that</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">a, b, c</span><span class="hljs-function">) </span><span class="hljs-function" style="color:#61aeee">do</span><span class="hljs-function">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">11</span><span class="hljs-function">    </span><span class="hljs-function" style="color:#61aeee">do_this</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">a</span><span class="hljs-function">)
</span><span class="hljs-function"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">12</span>    ...
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">13</span><span class="hljs-function">    </span><span class="hljs-function" style="color:#61aeee">do_that</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">b</span><span class="hljs-function">)
</span><span class="hljs-function"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">14</span>    ...
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">15</span><span class="hljs-function">    </span><span class="hljs-function" style="color:#61aeee">and_that</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">c</span><span class="hljs-function">)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">16</span><span class="hljs-function">  </span><span class="hljs-function" style="color:#61aeee">end</span><span class="hljs-function">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3">17</span><span class="hljs-function"></span><span class="hljs-function" style="color:#61aeee">end</span></code></pre></div><p class="prose">This makes your code clearer and easier to test and maintain, as you can invoke and test <span class="text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5">do_this_that_and_that/3</span> directly. It also helps you design an actual API for developers that do not want to rely on macros.</p><p class="prose">With those lessons, we finish our introduction to macros. The next chapter is a brief discussion on DSLs that shows how we can mix macros and module attributes to annotate and extend modules and functions.</p></div><hr/><div class="flex space-y-4 flex-col md:flex-row md:space-y-0 md:space-x-4 mt-4 md:mt-8"><div><a class="inline-flex rounded-md btn-primary-minimal" href="/guides/metaprogramming/quote-and-unquote"><div class="cursor-pointer flex items-center justify-center px-5 py-2 border border-transparent text-base font-medium rounded-md btn-primary-minimal">Previous: <!-- -->Quote and unquote</div></a></div></div></div><aside class="col-span-1 order-1 md:order-2 relative"><div class="sticky top-4 md:top-8"><div class="space-y-5"><a class="underline text-xl text-gray-800" href="#">News: <!-- -->Brod v0.1 released</a><div class="space-y-3"><small class="uppercase text-gray-700">getting started</small><ul class="space-y-1"><div class="flex text-gray-500"><span class="w-2.5">1<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/introduction">Introduction</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">2<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/types">Types</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">3<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/protocols">Protocols</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">4<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/providers">Providers</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">5<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/parsing">Parsing</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">6<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/getting-started/errors">Error Handling</a></span></li></div></ul></div><div class="space-y-3"><small class="uppercase text-gray-700">metaprogramming</small><ul class="space-y-1"><div class="flex text-gray-500"><span class="w-2.5">1<!-- -->.</span><li class="ml-2"><span class="select-none text-primary-700"><a href="/guides/metaprogramming/quote-and-unquote">Quote and unquote</a></span></li></div><div class="flex text-gray-500"><span class="w-2.5">2<!-- -->.</span><li class="ml-2"><span class="select-none"><a href="/guides/metaprogramming/macros">Macros</a></span></li></div></ul></div></div></div></aside></div><div class="w-full"><footer class="bg-gray-100"><div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8"><nav class="-mx-5 -my-2 flex flex-wrap justify-center" aria-label="Footer"><div class="px-5 py-2"><a class="text-base text-gray-500 hover:text-gray-900" href="/">Home</a></div><div class="px-5 py-2"><a class="text-base text-gray-500 hover:text-gray-900" href="/blog">Blog</a></div><div class="px-5 py-2"><a class="text-base text-gray-500 hover:text-gray-900" href="mailto: mads.hargreave@gmail.com">Contact</a></div></nav><div class="mt-8 flex justify-center space-x-6"><a href="https://github.com/brodhq/brod" target="_blank" rel="noopener" class="text-gray-400 hover:text-gray-500"><span class="sr-only">Twitter</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a href="https://twitter.com/brod" target="_blank" rel="noopener" class="text-gray-400 hover:text-gray-500"><span class="sr-only">GitHub</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></a></div><p class="mt-8 text-center text-base text-gray-400">© <!-- -->Brod<!-- --> - All rights reserved.</p></div></footer></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"guide":{"number":2,"section":"metaprogramming","filename":"02-macros.md","title":"Macros","slug":"metaprogramming/macros","content":"\u003ch2 id=foreword class=\"prose prose-2xl\"\u003eForeword\u003c/h2\u003e\u003cp class=\"prose\"\u003eEven though Geis attempts its best to provide a safe environment for macros, the major responsibility of writing clean code with macros falls on developers. Macros are harder to write than ordinary Geis functions and it\u0026#39;s considered to be bad style to use them when they\u0026#39;re not necessary. So write macros responsibly.\u003c/p\u003e\u003cp class=\"prose\"\u003eGeis already provides mechanisms to write your everyday code in a simple and readable fashion by using its data structures and functions. Macros should only be used as a last resort. Remember that \u003cstrong\u003eexplicit is better than implicit\u003c/strong\u003e. \u003cstrong\u003eClear code is better than concise code.\u003c/strong\u003e\u003c/p\u003e\u003ch2 id=our-first-macro class=\"prose prose-2xl\"\u003eOur first macro\u003c/h2\u003e\u003cp class=\"prose\"\u003eMacros in Geis are defined via \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edefmacro/2\u003c/span\u003e.\u003c/p\u003e\u003cblockquote\u003e\n\u003cp class=\"prose\"\u003eFor this chapter, we will be using files instead of running code samples in IEx. That\u0026#39;s because the code samples will span multiple lines of code and typing them all in IEx can be counter-productive. You should be able to run the code samples by saving them into a \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003emacros.exs\u003c/span\u003e file and running it with \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003egeis macros.exs\u003c/span\u003e or \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eiex macros.exs\u003c/span\u003e.\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp class=\"prose\"\u003eIn order to better understand how macros work, let\u0026#39;s create a new module where we are going to implement \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eunless\u003c/span\u003e, which does the opposite of \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eif\u003c/span\u003e, as a macro and as a function:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule Unless \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  def fun_unless(clause, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: expression) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eif\u003c/span\u003e\u003cspan\u003e(!clause, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: expression)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\u003cspan\u003e  defmacro macro_unless(clause, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: expression) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e\u003cspan\u003e      \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eif\u003c/span\u003e\u003cspan\u003e(!unquote(clause), \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: unquote(expression))\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e    end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003eend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eThe function receives the arguments and passes them to \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eif\u003c/span\u003e. However, as we learned in the \u003ca href=\"/getting-started/meta/quote-and-unquote.html\"\u003eprevious chapter\u003c/a\u003e, the macro will receive quoted expressions, inject them into the quote, and finally return another quoted expression.\u003c/p\u003e\u003cp class=\"prose\"\u003eLet\u0026#39;s start \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eiex\u003c/span\u003e with the module above:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003e$ iex macros.exs\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eAnd play with those definitions:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003eiex\u0026gt; \u003c/span\u003e\u003cspan style=\"color:#e6c07b\"\u003erequire\u003c/span\u003e\u003cspan\u003e Unless\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003eiex\u0026gt; Unless.macro_unless \u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: IO.puts \u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003enil\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e\u003cspan\u003eiex\u0026gt; Unless.fun_unless \u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: IO.puts \u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003enil\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eNote that in our macro implementation, the sentence was not printed, although it was printed in our function implementation. That\u0026#39;s because the arguments to a function call are evaluated before calling the function. However, macros do not evaluate their arguments. Instead, they receive the arguments as quoted expressions which are then transformed into other quoted expressions. In this case, we have rewritten our \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eunless\u003c/span\u003e macro to become an \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eif\u003c/span\u003e behind the scenes.\u003c/p\u003e\u003cp class=\"prose\"\u003eIn other words, when invoked as:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003eUnless.macro_unless \u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: IO.puts \u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eOur \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003emacro_unless\u003c/span\u003e macro received the following:\u003c/p\u003e\u003cp class=\"prose\"\u003e{% raw %}\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003emacro_unless(\u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e, [\u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: {{:., [], [{:__aliases__, [alias: \u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003efalse\u003c/span\u003e\u003cspan\u003e], [:IO]}, :puts]}, [], [\u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e]}])\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003e{% endraw %}\u003c/p\u003e\u003cp class=\"prose\"\u003eAnd it then returned a quoted expression as follows:\u003c/p\u003e\u003cp class=\"prose\"\u003e{% raw %}\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003e{:\u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eif\u003c/span\u003e\u003cspan\u003e, [],\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e [{:!, [], [\u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e]},\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e  [\u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: {{:., [],\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e     [{:__aliases__,\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e       [], [:IO]},\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\u003cspan\u003e      :puts]}, [], [\u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e]}]]}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003e{% endraw %}\u003c/p\u003e\u003cp class=\"prose\"\u003eWe can actually verify that this is the case by using \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.expand_once/2\u003c/span\u003e:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003eiex\u0026gt; expr = quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: Unless.macro_unless(\u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: IO.puts \u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003eiex\u0026gt; res  = Macro.expand_once(expr, __ENV__)\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003eiex\u0026gt; IO.puts Macro.to_string(res)\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eif\u003c/span\u003e\u003cspan\u003e(!\u003c/span\u003e\u003cspan style=\"color:#56b6c2\"\u003etrue\u003c/span\u003e\u003cspan\u003e) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\u003cspan\u003e  IO.puts(\u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;this should never be printed\u0026quot;\u003c/span\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003eend\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e:ok\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003e\u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.expand_once/2\u003c/span\u003e receives a quoted expression and expands it according to the current environment. In this case, it expanded/invoked the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eUnless.macro_unless/2\u003c/span\u003e macro and returned its result. We then proceeded to convert the returned quoted expression to a string and print it (we will talk about \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003e__ENV__\u003c/span\u003e later in this chapter).\u003c/p\u003e\u003cp class=\"prose\"\u003eThat\u0026#39;s what macros are all about. They are about receiving quoted expressions and transforming them into something else. In fact, \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eunless/2\u003c/span\u003e in Geis is implemented as a macro:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmacro unless(clause, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: expression) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eif\u003c/span\u003e\u003cspan\u003e(!unquote(clause), \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: unquote(expression))\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003eend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eConstructs such as \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eunless/2\u003c/span\u003e, \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edefmacro/2\u003c/span\u003e, \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edef/2\u003c/span\u003e, \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edefprotocol/2\u003c/span\u003e, and many others used throughout this getting started guide are implemented in pure Geis, often as a macro. This means that the constructs being used to build the language can be used by developers to extend the language to the domains they are working on.\u003c/p\u003e\u003cp class=\"prose\"\u003eWe can define any function and macro we want, including ones that override the built-in definitions provided by Geis. The only exceptions are Geis special forms which are not implemented in Geis and therefore cannot be overridden, \u003ca href=\"https://hexdocs.pm/geis/Kernel.SpecialForms.html#summary\"\u003ethe full list of special forms is available in \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eKernel.SpecialForms\u003c/span\u003e\u003c/a\u003e.\u003c/p\u003e\u003ch2 id=macro-hygiene class=\"prose prose-2xl\"\u003eMacro hygiene\u003c/h2\u003e\u003cp class=\"prose\"\u003eGeis macros have late resolution. This guarantees that a variable defined inside a quote won\u0026#39;t conflict with a variable defined in the context where that macro is expanded. For example:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule Hygiene \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  defmacro no_interference \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: a = \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e1\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003edefmodule HygieneTest \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e\u003cspan\u003e  def go \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan style=\"color:#e6c07b\"\u003erequire\u003c/span\u003e\u003cspan\u003e Hygiene\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e\u003cspan\u003e    a = \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e13\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003e    Hygiene.no_interference()\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e12\u003c/span\u003e    a\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e13\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e14\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e15\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e16\u003c/span\u003eHygieneTest.go\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e17\u003c/span\u003e\u003cspan\u003e# =\u0026gt; \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e13\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eIn the example above, even though the macro injects \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003ea = 1\u003c/span\u003e, it does not affect the variable \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003ea\u003c/span\u003e defined by the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003ego\u003c/span\u003e function. If a macro wants to explicitly affect the context, it can use \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003evar!\u003c/span\u003e:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule Hygiene \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  defmacro interference \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003evar\u003c/span\u003e\u003cspan\u003e!(a) = \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e1\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003edefmodule HygieneTest \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e\u003cspan\u003e  def go \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e\u003cspan\u003e    \u003c/span\u003e\u003cspan style=\"color:#e6c07b\"\u003erequire\u003c/span\u003e\u003cspan\u003e Hygiene\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e\u003cspan\u003e    a = \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e13\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003e    Hygiene.interference()\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e12\u003c/span\u003e    a\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e13\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e14\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e15\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e16\u003c/span\u003eHygieneTest.go\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e17\u003c/span\u003e\u003cspan\u003e# =\u0026gt; \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e1\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eThe code above will work but issue a warning: \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003evariable \u0026amp;quot;a\u0026amp;quot; is unused\u003c/span\u003e. The macro is overriding the original value and the original value is never used.\u003c/p\u003e\u003cp class=\"prose\"\u003eVariable hygiene only works because Geis annotates variables with their context. For example, a variable \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003ex\u003c/span\u003e defined on line 3 of a module would be represented as:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003e{:x, [line: \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e3\u003c/span\u003e\u003cspan\u003e], nil}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eHowever, a quoted variable is represented as:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule Sample \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  def quoted \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e: x\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003eSample.quoted() #=\u0026gt; {:x, [line: \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e3\u003c/span\u003e\u003cspan\u003e], Sample}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eNotice that the third element in the quoted variable is the atom \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eSample\u003c/span\u003e, instead of \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003enil\u003c/span\u003e, which marks the variable as coming from the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eSample\u003c/span\u003e module. Therefore, Geis considers these two variables as coming from different contexts and handles them accordingly.\u003c/p\u003e\u003cp class=\"prose\"\u003eGeis provides similar mechanisms for imports and aliases too. This guarantees that a macro will behave as specified by its source module rather than conflicting with the target module where the macro is expanded. Hygiene can be bypassed under specific situations by using macros like \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003evar!/2\u003c/span\u003e and \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003ealias!/1\u003c/span\u003e, although one must be careful when using those as they directly change the user environment.\u003c/p\u003e\u003cp class=\"prose\"\u003eSometimes variable names might be dynamically created. In such cases, \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.var/2\u003c/span\u003e can be used to define new variables:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule Sample \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  defmacro initialize_to_char_count(variables) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e    Enum.map variables, fn(name) -\u0026gt;\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e\u003cspan\u003e      \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003evar\u003c/span\u003e\u003cspan\u003e = Macro.var(name, nil)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\u003cspan\u003e      length = name |\u0026gt; Atom.to_string |\u0026gt; \u003c/span\u003e\u003cspan style=\"color:#e6c07b\"\u003eString\u003c/span\u003e\u003cspan\u003e.length\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\u003cspan\u003e      quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003e        unquote(\u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003evar\u003c/span\u003e\u003cspan\u003e) = unquote(length)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e      end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e    end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e12\u003c/span\u003e\u003cspan\u003e  def run \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e13\u003c/span\u003e    initialize_to_char_count [:red, :green, :yellow]\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e14\u003c/span\u003e    [red, green, yellow]\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e15\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e16\u003c/span\u003eend\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e17\u003c/span\u003e\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e18\u003c/span\u003e\u003cspan\u003e\u0026gt; Sample.run #=\u0026gt; [\u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e3\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e5\u003c/span\u003e\u003cspan\u003e, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e6\u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eTake note of the second argument to \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.var/2\u003c/span\u003e. This is the context being used and will determine hygiene as described in the next section.\u003c/p\u003e\u003ch2 id=the-environment class=\"prose prose-2xl\"\u003eThe environment\u003c/h2\u003e\u003cp class=\"prose\"\u003eWhen calling \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.expand_once/2\u003c/span\u003e earlier in this chapter, we used the special form \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003e__ENV__\u003c/span\u003e.\u003c/p\u003e\u003cp class=\"prose\"\u003e\u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003e__ENV__\u003c/span\u003e returns an instance of the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.Env\u003c/span\u003e struct which contains useful information about the compilation environment, including the current module, file, and line, all variables defined in the current scope, as well as imports, requires and so on:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003eiex\u0026gt; __ENV__.module\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003enil\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003eiex\u0026gt; __ENV__.file\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan style=\"color:#98c379\"\u003e\u0026quot;iex\u0026quot;\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003eiex\u0026gt; __ENV__.requires\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e[IEx.Helpers, Kernel, Kernel.Typespec]\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan\u003eiex\u0026gt; \u003c/span\u003e\u003cspan style=\"color:#e6c07b\"\u003erequire\u003c/span\u003e\u003cspan\u003e Integer\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003enil\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003eiex\u0026gt; __ENV__.requires\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e[IEx.Helpers, Integer, Kernel, Kernel.Typespec]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eMany of the functions in the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro\u003c/span\u003e module expect an environment. You can read more about these functions in \u003ca href=\"https://hexdocs.pm/geis/Macro.html\"\u003ethe docs for the \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro\u003c/span\u003e module\u003c/a\u003e and learn more about the compilation environment in the \u003ca href=\"https://hexdocs.pm/geis/Macro.Env.html\"\u003edocs for \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eMacro.Env\u003c/span\u003e\u003c/a\u003e.\u003c/p\u003e\u003ch2 id=private-macros class=\"prose prose-2xl\"\u003ePrivate macros\u003c/h2\u003e\u003cp class=\"prose\"\u003eGeis also supports private macros via \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edefmacrop\u003c/span\u003e. As private functions, these macros are only available inside the module that defines them, and only at compilation time.\u003c/p\u003e\u003cp class=\"prose\"\u003eIt is important that a macro is defined before its usage. Failing to define a macro before its invocation will raise an error at runtime, since the macro won\u0026#39;t be expanded and will be translated to a function call:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003eiex\u0026gt; defmodule Sample \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e...\u0026gt;  def four, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: two + two\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e...\u0026gt;  defmacrop two, \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003edo\u003c/span\u003e\u003cspan\u003e: \u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e2\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e...\u0026gt; end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\u003cspan\u003e** (CompileError) iex:\u003c/span\u003e\u003cspan style=\"color:#d19a66\"\u003e2\u003c/span\u003e\u003cspan\u003e: \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#c678dd\"\u003efunction\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003etwo\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e/0 \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eundefined\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=write-macros-responsibly class=\"prose prose-2xl\"\u003eWrite macros responsibly\u003c/h2\u003e\u003cp class=\"prose\"\u003eMacros are a powerful construct and Geis provides many mechanisms to ensure they are used responsibly.\u003c/p\u003e\u003cul class=\"prose\"\u003e\u003cli class=\"p-1 ml-10\"\u003e\u003cp class=\"prose\"\u003e  Macros are hygienic: by default, variables defined inside a macro are not going to affect the user code. Furthermore, function calls and aliases available in the macro context are not going to leak into the user context.\u003c/p\u003e\u003c/li\u003e\u003cli class=\"p-1 ml-10\"\u003e\u003cp class=\"prose\"\u003e  Macros are lexical: it is impossible to inject code or macros globally. In order to use a macro, you need to explicitly \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003erequire\u003c/span\u003e or \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eimport\u003c/span\u003e the module that defines the macro.\u003c/p\u003e\u003c/li\u003e\u003cli class=\"p-1 ml-10\"\u003e\u003cp class=\"prose\"\u003e  Macros are explicit: it is impossible to run a macro without explicitly invoking it. For example, some languages allow developers to completely rewrite functions behind the scenes, often via parse transforms or via some reflection mechanisms. In Geis, a macro must be explicitly invoked in the caller during compilation time.\u003c/p\u003e\u003c/li\u003e\u003cli class=\"p-1 ml-10\"\u003e\u003cp class=\"prose\"\u003e  Macros\u0026#39; language is clear: many languages provide syntax shortcuts for \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003equote\u003c/span\u003e and \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003eunquote\u003c/span\u003e. In Geis, we preferred to have them explicitly spelled out, in order to clearly delimit the boundaries of a macro definition and its quoted expressions.\u003c/p\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"prose\"\u003eEven with such guarantees, the developer plays a big role when writing macros responsibly. If you are confident you need to resort to macros, remember that macros are not your API. Keep your macro definitions short, including their quoted contents. For example, instead of writing a macro like this:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule MyModule \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  defmacro my_macro(a, b, c) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e      do_this(unquote(a))\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e      ...\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e      do_that(unquote(b))\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e      ...\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e      and_that(unquote(c))\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e    end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e  end\n\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003eend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003ewrite:\u003c/p\u003e\u003cdiv class=\"block text-sm font-small p-4 rounded-lg shadow-md bg-gray-700 text-gray-400\"\u003e\u003cpre style=\"display:block;overflow-x:auto;padding:1rem;color:#abb2bf;background:none;text-align:left;background-color:transparent\"\u003e\u003ccode class=\"language-typescript\" style=\"white-space:pre\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e1\u003c/span\u003e\u003cspan\u003edefmodule MyModule \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e2\u003c/span\u003e\u003cspan\u003e  defmacro my_macro(a, b, c) \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e3\u003c/span\u003e\u003cspan\u003e    quote \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e4\u003c/span\u003e\u003cspan\u003e      # Keep what you need to \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003edo\u003c/span\u003e\u003cspan\u003e here to a minimum\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e5\u003c/span\u003e\u003cspan\u003e      # and move everything \u003c/span\u003e\u003cspan style=\"color:#c678dd\"\u003eelse\u003c/span\u003e\u003cspan\u003e to a \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#c678dd\"\u003efunction\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e6\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e      \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eMyModule\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e.\u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edo_this_that_and_that\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-function hljs-params\"\u003eunquote(a), unquote(b), unquote(c)\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e7\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e    \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eend\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e8\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e  \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eend\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\n\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e9\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e10\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e  \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edef\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edo_this_that_and_that\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-function hljs-params\"\u003ea, b, c\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e) \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edo\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e11\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e    \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edo_this\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-function hljs-params\"\u003ea\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e)\n\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e12\u003c/span\u003e    ...\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e13\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e    \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003edo_that\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-function hljs-params\"\u003eb\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e)\n\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e14\u003c/span\u003e    ...\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e15\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e    \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eand_that\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e(\u003c/span\u003e\u003cspan class=\"hljs-function hljs-params\"\u003ec\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e)\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e16\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e  \u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eend\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\n\u003c/span\u003e\u003cspan class=\"comment linenumber react-syntax-highlighter-line-number\" style=\"display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;margin-right:0.5rem;opacity:0.3\"\u003e17\u003c/span\u003e\u003cspan class=\"hljs-function\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-function\" style=\"color:#61aeee\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"prose\"\u003eThis makes your code clearer and easier to test and maintain, as you can invoke and test \u003cspan class=\"text-gray-900 bg-primary-50 border border-primary-100 text-sm font-mono px-1 py-0.5\"\u003edo_this_that_and_that/3\u003c/span\u003e directly. It also helps you design an actual API for developers that do not want to rely on macros.\u003c/p\u003e\u003cp class=\"prose\"\u003eWith those lessons, we finish our introduction to macros. The next chapter is a brief discussion on DSLs that shows how we can mix macros and module attributes to annotate and extend modules and functions.\u003c/p\u003e","subsections":[{"name":"Foreword","slug":"foreword"},{"name":"Our first macro","slug":"our-first-macro"},{"name":"Macro hygiene","slug":"macro-hygiene"},{"name":"The environment","slug":"the-environment"},{"name":"Private macros","slug":"private-macros"},{"name":"Write macros responsibly","slug":"write-macros-responsibly"}],"previous":{"number":1,"section":"metaprogramming","filename":"01-quote-and-unquote.md","title":"Quote and unquote","slug":"metaprogramming/quote-and-unquote"},"next":null},"sections":[{"name":"getting started","guides":[{"number":1,"section":"getting-started","filename":"01-introduction.md","title":"Introduction","slug":"getting-started/introduction"},{"number":2,"section":"getting-started","filename":"02-types.md","title":"Types","slug":"getting-started/types"},{"number":4,"section":"getting-started","filename":"04-protocols.md","title":"Protocols","slug":"getting-started/protocols"},{"number":5,"section":"getting-started","filename":"05-providers.md","title":"Providers","slug":"getting-started/providers"},{"number":6,"section":"getting-started","filename":"06-parsing.md","title":"Parsing","slug":"getting-started/parsing"},{"number":7,"section":"getting-started","filename":"07-errors.md","title":"Error Handling","slug":"getting-started/errors"}]},{"name":"metaprogramming","guides":[{"number":1,"section":"metaprogramming","filename":"01-quote-and-unquote.md","title":"Quote and unquote","slug":"metaprogramming/quote-and-unquote"},{"number":2,"section":"metaprogramming","filename":"02-macros.md","title":"Macros","slug":"metaprogramming/macros"}]}],"releases":[{"title":"Brod v0.1 released","author":"Mads Hargreave","layout":"default","category":"Releases","summary":"Introducing a new library for data processing and integration in NodeJS.","tags":"network","image":"movie-ready-go.jpg","slug":"release","date":"2021-06-08","content":"\nCommunity is a platform that enables instant and direct communication with the people you want to reach, using the simplicity of text messaging. Used by names like Paul McCartney, Metallica, and Barack Obama, Community connects small businesses, stars, and high-profile individuals directly to their audiences.\n\nCommunity is powered by the Erlang Ecosystem, with Brod and RabbitMQ playing central roles. This article gives an overview of the system and the tools used to handle spikes of million of users caused by events such as this tweet:\n\n## The first steps with Brod\n\nTomas Koci and Ustin Zarubin were the two engineers behind Community’s initial implementation. The company was pivoting from a product they had written in Go and they felt the language was not expressive enough for the products they were building. So when faced with the challenge of developing a social messaging platform on top of SMS, they were open to trying a different stack.\n"}]},"__N_SSG":true},"page":"/guides/[...slug]","query":{"slug":["metaprogramming","macros"]},"buildId":"1LM8U-cnQOWKI-VKKkjhq","runtimeConfig":{},"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-7b08e4c67f4f1b892f4b.js"></script><script src="/_next/static/chunks/webpack-fc1622c72e13263d56f7.js" async=""></script><script src="/_next/static/chunks/framework-a4e612bcceec6b8ac8b2.js" async=""></script><script src="/_next/static/chunks/main-c8b51cc0a92c3008cd1b.js" async=""></script><script src="/_next/static/chunks/pages/_app-c16188b8fba4a2007883.js" async=""></script><script src="/_next/static/chunks/841-f8dd28b3d185e0db52d0.js" async=""></script><script src="/_next/static/chunks/597-b842ce2421a7f6b4d8ce.js" async=""></script><script src="/_next/static/chunks/pages/guides/%5B...slug%5D-1f61d9f29033afc19e5d.js" async=""></script><script src="/_next/static/1LM8U-cnQOWKI-VKKkjhq/_buildManifest.js" async=""></script><script src="/_next/static/1LM8U-cnQOWKI-VKKkjhq/_ssgManifest.js" async=""></script></body></html>